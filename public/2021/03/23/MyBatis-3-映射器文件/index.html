<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="gaylong9">



    <meta name="description" content="年更博客 自娱自乐">



<title>MyBatis-3-映射器文件 | gaylong9`s blog</title>
<link href="https://cdn.bootcss.com/KaTeX/0.7.1/katex.min.css" rel="stylesheet">



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">gaylong9&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">gaylong9&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">MyBatis-3-映射器文件</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">gaylong9</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 23, 2021&nbsp;&nbsp;10:00:35</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>&nbsp;</p>
<span id="more"></span>
<!-- toc -->
<p>&nbsp;</p>
<p>[toc]</p>
<h1 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h1><p>由一个接口和XML文件（注解不推荐）组成。映射器中可以配置参数、各类SQL语句、存储过程、缓存、级联等内容，并通过简易的映射规则映射到指定的POJO上，有效消除JDBC底层代码。</p>
<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>有以下元素：</p>
<ul>
<li>select：查询，可以自定义参数、返回结果集等</li>
<li>insert：插入，返回一个整数，代表插入的条数</li>
<li>update：更新，返回整数，代表更新的条数</li>
<li>delete：删除，返回整数，代表删除的条数</li>
<li>parameterMap：定义参数映射关系，但即将被删除，不推荐使用</li>
<li>sql：定义一部分SQL，其他地方引用</li>
<li>resultMap：描述从结果集中加载对象，提供映射规则</li>
<li>cache：给定命名空间的缓存配置</li>
<li>chche-ref：其他命名空间缓存配置的引用</li>
</ul>
<p>&nbsp;</p>
<h2 id="2-select-查询"><a href="#2-select-查询" class="headerlink" title="2. select 查询"></a>2. select 查询</h2><h3 id="2-1-属性"><a href="#2-1-属性" class="headerlink" title="2.1 属性"></a>2.1 属性</h3><pre><code>1. id：和Mapper的命名空间namespace组合起来是唯一的，供MyBatis调用
</code></pre><ol>
<li>parameterType：类全名/别名</li>
<li>parameterMap：即将废弃</li>
<li>resultType：定义类全路径，允许自动匹配时结果集自动映射；或int double等；也可用别名，但不能和resultMap同时使用</li>
<li>resultMap：映射集的引用，和resultType二选一使用，能提供自定义映射规则</li>
<li>flushCache：调用SQL后是否清空之前查询本地缓存和二级缓存，默认false</li>
<li>useCache：启动二级缓存的开关，是否要将此次结果缓存，默认true</li>
<li>timeout：超时参数，s，超时异常</li>
<li>fetchSize：获取记录的总条数设定</li>
<li>statementType：使用JDBC的哪个Statement工作，有STATEMENT（Statement）、PREPARED（PreparedStatement）、CALLABLE（CallableStatement），默认PREPARED</li>
<li>resultSetType：对JDBC的resultSet接口而言，包括FORWARD_ONLY（游标允许向前访问）、SCROLL_SENSITIVE（双向滚动，但不及时更新，若库中数据修改过，不在resultSet中反映）、SCROLL_INSENSITIVE（双向滚动，及时跟踪库更新）</li>
<li>databaseId：参考databaseIDProvider</li>
<li>resultOrdered：仅适用于嵌套结果select，true表示假设包含了嵌套结果集或是分组了，当返回一个主结果行时，就不能引用前面结果集了，确保在获取嵌套的结果集时不至于爆内存；默认false</li>
<li>resultSets：适用于多个结果集的情况，列出执行SQL后每个结果集的名称，逗号分隔</li>
</ol>
<p>用的最多的是id、parameterType、resultType、resultMap；若要设置缓存还用到flushCache、useCache；其他不常用。</p>
<h3 id="2-2-简单应用"><a href="#2-2-简单应用" class="headerlink" title="2.2 简单应用"></a>2.2 简单应用</h3><p>eg：统计表中同一姓氏的用户数量：接口中声明方法：<code>public Integer countUserByFirstName(String firstName);</code>然后mapper.xml中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;countUserByFirstName&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;string&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(*) total from t_user </span><br><span class="line">    where user_name like concat(#&#123;firstName&#125;, &#x27;%&#x27;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>​    id：配合主元素mapper的namespace属性，联合成为唯一标识</p>
<p>​    parameterType：接受的参数类型，可以是别名或全名</p>
<p>​    resultType：返回类型，同样可以全名或别名</p>
<p>​    #{firstName}：传入的参数</p>
<h3 id="2-3-自动映射"><a href="#2-3-自动映射" class="headerlink" title="2.3 自动映射"></a>2.3 自动映射</h3><pre><code>  1. MyBatis提供自动映射功能，默认开启，能有效减少大量的映射配置

  2. 基础配置文件中的setting元素中有两个可配置选项autoMappingBehavior或mapUnderscoreToCamelCase，用于控制自动映射和驼峰映射的开关，前者使用的多，灵活，后者严苛，使用不广
  3. autoMappingBehavior的取值：
1. NONE：不进行自动映射
  2. PARTIAL：默认，只对没有嵌套结果集进行自动映射
  3. FULL：对所有结果集进行自动映射
  4. 编写POJO中的属性，如果和表列名一致，就能自动映射；不一致也可在SQL中通过`as`改为一致
  5. 驼峰映射：表列名 user_name，POJO属性名userName，此时可以映射
</code></pre><h3 id="2-4-传入多个参数"><a href="#2-4-传入多个参数" class="headerlink" title="2.4 传入多个参数"></a>2.4 传入多个参数</h3><ol>
<li><p>使用map接口传递：此时将接口的方法定义为<code>public List&lt;Book&gt; findBooksByMap(Map&lt;String, Object&gt; parameterMap);</code>，此时传入映射器的就是一个map对象，使用这个map在SQL中设置参数：</p>
</li>
<li><p>```xml<br> <select id="findBooksByMap" parameterType="map" resultType="book"></p>
<pre><code> select id, book_name as bookName from books where book_name like concat(&#39;%&#39;, #&#123;bookName&#125;, &#39;%&#39;) and id like concat(&#39;%&#39;, #&#123;id&#125;, &#39;%&#39;)
</code></pre><p> &lt;/select&gt;</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	SQL中#&#123;bookName&#125;是键，要在调用方法前填充map传入。但因map可读性差，不能限定传入参数类型，故使用不多</span><br><span class="line"></span><br><span class="line">3. 使用注解传递：`public List&lt;Book&gt; findBooksByAnnotation(@Param(&quot;roleName&quot;) String roleName, @Param(&quot;id&quot;) String id);`，可读性大大提高，在SQL中使用参数时，花括号内填入注解的内容即可，且此时不用指定parameterType属性，MyBatis可以自动探索</span><br><span class="line"></span><br><span class="line">4. 使用JavaBean传递：参数过多时注解繁琐，可用一个POJO代表参数</span><br><span class="line"></span><br><span class="line">	```java</span><br><span class="line">	public class BookParams &#123;</span><br><span class="line">	    private String bookName;</span><br><span class="line">	    private String id;</span><br><span class="line">	    // getter setter</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p> 此时接口方法定义：<code>public List&lt;Book&gt; findBooksByBean(BookParams bookParam);</code>；映射器中parameterType指定该JavaBean全名，花括号内用bean的属性即可</p>
</li>
</ol>
<h3 id="2-5-resultMap映射结果集"><a href="#2-5-resultMap映射结果集" class="headerlink" title="2.5 resultMap映射结果集"></a>2.5 resultMap映射结果集</h3><p>自动映射规则简单，无法定义多的属性。复杂映射使用resultMap，首先需要定义resultMap元素，然后可在select中使用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;roleMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;role&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;roleName&quot;</span> <span class="attr">column</span>=<span class="string">&quot;role_name&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRole&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;roleMap&quot;</span>&gt;</span></span><br><span class="line">    	sql</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>resultMap元素定义了一个roleMap，id是其标识，type标识要映射的类。</p>
<p>子元素id是主键，result代表其他属性；property代表POJO的属性名，column是SQL的列名，如此便建立了映射联系。</p>
<h3 id="2-6-分页参数RowBounds"><a href="#2-6-分页参数RowBounds" class="headerlink" title="2.6 分页参数RowBounds"></a>2.6 分页参数RowBounds</h3><ol>
<li>对查询到的结果取部分。RowBounds类内有offset和limit两个属性。<ol>
<li>offset表示偏移量，即从第几行开始读取，默认0。</li>
<li>limit表示限制条数，默认Integer.MAX。</li>
</ol>
</li>
<li>要使用RowBounds，只需在接口参数最后增加一个<code>RowBounds rowBounds</code>即可，在映射文件中无需特别设置，MyBatis自动识别应用。</li>
<li>小数据量适用，大量时用插件。</li>
</ol>
<p>&nbsp;</p>
<h2 id="3-insert-插入"><a href="#3-insert-插入" class="headerlink" title="3. insert 插入"></a>3. insert 插入</h2><h3 id="3-1-属性"><a href="#3-1-属性" class="headerlink" title="3.1 属性"></a>3.1 属性</h3><ul>
<li>id：SQL标号，标识</li>
<li>parameterType：参数类型</li>
<li>flushCache：是否刷新缓存，默认true表示插入后刷新一二级缓存</li>
<li>timeout：s</li>
<li>StatementType：STATEMENT（Statement）, PREPARED（PreparedStatement, CALLABLE（CALLABLEStatement），默认PREPARED</li>
<li>useGeneratedKeys：是否启用Jdbc的getGeneratedKeys方法来取出数据库自动生成的主键（如MySQL的自增主键），默认false</li>
<li>keyProperty：（仅insert和update）唯一标记一个恶属性，通过useGeneratedKeys或insert的selectKey子元素设置它的键值</li>
<li>keyColumn：（仅insert和update）</li>
<li>databaseId</li>
</ul>
<p>insert后，返回一个整数表示影响了个条数。</p>
<h3 id="3-2-简单应用"><a href="#3-2-简单应用" class="headerlink" title="3.2 简单应用"></a>3.2 简单应用</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertRole&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;role&quot;</span>&gt;</span></span><br><span class="line">    insert into t_role (role_name, note) values(#&#123;roleName&#125;,#&#123;note&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-3-主键回填"><a href="#3-3-主键回填" class="headerlink" title="3.3 主键回填"></a>3.3 主键回填</h3><ol>
<li>意义：MySQL中对主键有自增功能，故上述例子中没有插入id主键。但有时需要利用插入的元组的主键，就需要获取到库自增的主键的值。</li>
<li>JDBC中Statement执行插入后，可以通过getGeneratedKeys方法获得生成的主键。MyBatis中的insert有开关属性useGeneratedKeys，默认false，打开后需要配置属性keyProperty或keyColumn，用于告诉系统将回填的主键填入哪个属性</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">	sql</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如此，就将主键id回填到POJO的id属性内。</p>
<h3 id="3-4-自定义主键"><a href="#3-4-自定义主键" class="headerlink" title="3.4 自定义主键"></a>3.4 自定义主键</h3><ol>
<li>意义；有时主键不需自增，而是依赖某些规则，如本例的表空时id为1，不空时id为当前id+3</li>
<li>MyBatis中此功能依赖于selectKey元素</li>
<li>selectKey有order属性，其值BEFORE/AFTER表示此主键定义是在SQL前或后执行</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span> <span class="attr">parameterType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">order</span>=<span class="string">&quot;BEFORE&quot;</span>&gt;</span></span><br><span class="line">        select if (max(id)=null, 1, max(id)+3) from t_role</span><br><span class="line">    <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line">    sql</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;</p>
<h2 id="4-update和delete"><a href="#4-update和delete" class="headerlink" title="4. update和delete"></a>4. update和delete</h2><p>属性类似上面，且同样返回整数表示影响的行数。</p>
<p>&nbsp;</p>
<h2 id="5-sql元素"><a href="#5-sql元素" class="headerlink" title="5. sql元素"></a>5. sql元素</h2><p>定义一条SQL的一部分，随后可以引用，方便后续编写SQL。</p>
<p>如表中列多，可将所有列名设为一个sql元素，随后SQL语句中便可通过include引用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;roleCols&quot;</span>&gt;</span></span><br><span class="line">        id, role_name, note</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span> <span class="attr">parameterType</span>&gt;</span></span><br><span class="line">        select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;roleCols&quot;</span>/&gt;</span> from t_role where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>甚至支持变量传递，将SQL中的变量传给sql元素，然后sql元素引入SQL执行：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;roleCols&quot;</span>&gt;</span></span><br><span class="line">    $&#123;alias&#125;.id, $&#123;alias&#125;.role_name</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span> <span class="attr">parameterType</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;roleCols&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;alias&quot;</span> <span class="attr">value</span>=<span class="string">&quot;t_role&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>本例中，include元素将表名t_role赋值给alias变量。</p>
<p>&nbsp;</p>
<h2 id="6-参数"><a href="#6-参数" class="headerlink" title="6. 参数"></a>6. 参数</h2><p>《Java EE互联网轻量级框架整合开发》 MyBatis 5.6，暂不展开。</p>
<p>&nbsp;</p>
<h2 id="7-resultMap元素"><a href="#7-resultMap元素" class="headerlink" title="7. resultMap元素"></a>7. resultMap元素</h2><p>定义映射规则、级联的更新、定制类型转化器等。主要是一个结果集的映射关系，将SQL映射到JavaBean。MyBatis暂只支持resultMap查询，不支持更新或保存、级联的更新删除修改。</p>
<h3 id="7-1-resultMap元素构成"><a href="#7-1-resultMap元素构成" class="headerlink" title="7.1 resultMap元素构成"></a>7.1 resultMap元素构成</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">idArg</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">discriminator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">case</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>id表示主键。</p>
<p>result配置POJO到SQL列名的映射关系。</p>
<p>Constructor用于配置构造方法。POJO可能没有无参构造方法，就需要把有参构造方法配置进此，如<code>public RoleBean(Integer id, String roleName)</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">idArg</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;int&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">arg</span> <span class="attr">column</span>=<span class="string">&quot;role_name&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;string&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>result和idArg的属性：</p>
<ul>
<li>property：映射到列结果的字段或属性</li>
<li>column：对应SQL的列</li>
<li>javaType</li>
<li>jdbcType</li>
<li>typeHandler</li>
</ul>
<h3 id="7-2-使用map存储结果集"><a href="#7-2-使用map存储结果集" class="headerlink" title="7.2 使用map存储结果集"></a>7.2 使用map存储结果集</h3><p>map支持任何select的结果集存储，只需在select元素中配置属性<code>resultType=&quot;map&quot;</code>即可。但可读性差，一般使用POJO存储。</p>
<h3 id="7-3-使用POJO存储结果集"><a href="#7-3-使用POJO存储结果集" class="headerlink" title="7.3 使用POJO存储结果集"></a>7.3 使用POJO存储结果集</h3><p>POJO存储，就可以使用自动映射，或自定义更复杂的映射，当然这就要先创建一个resultMap元素（映射），见<a href="###2.5 resultMap映射结果集">2.5 resultMap映射结果集</a></p>
<p>&nbsp;</p>
<h2 id="8-级联"><a href="#8-级联" class="headerlink" title="8. 级联"></a>8. 级联</h2><h3 id="8-1-MyBatis中的级联"><a href="#8-1-MyBatis中的级联" class="headerlink" title="8.1 MyBatis中的级联"></a>8.1 MyBatis中的级联</h3><p>分为三种：</p>
<ol>
<li>鉴别器discriminator：根据某些条件决定采用具体实现类级联的方案</li>
<li>一对一association</li>
<li>一对多collection</li>
</ol>
<p>本例以学生Student、任务表Task、任务安排表ST、男女体检表Female/MaleForm、学生证表ID说明，学生与任务表一对多、与男女体检表属于鉴别器类型、与学生证一对一。</p>
<p>&nbsp;</p>
<h3 id="8-2-建立POJO"><a href="#8-2-建立POJO" class="headerlink" title="8.2 建立POJO"></a>8.2 建立POJO</h3><p>为每个实体建立POJO。</p>
<p>男女体检表，多数项目相同，可建立父类后继承：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthForm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long stuId;</span><br><span class="line">    <span class="keyword">private</span> String heart;</span><br><span class="line">    <span class="comment">// setter getter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FemaleForm</span> <span class="keyword">extends</span> <span class="title">HealthForm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String uterus;</span><br><span class="line">    <span class="comment">// settter getter</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MaleForm</span> <span class="keyword">extends</span> <span class="title">HealthForm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String prostate;</span><br><span class="line">    <span class="comment">// setter getter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>学生证表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IDCard</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long stuId;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>任务表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Task</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>任务安排表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ST</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long stuId;</span><br><span class="line">    <span class="keyword">private</span> Task task = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>学生表：建立父类，并继承男女学生，以适配男女体检单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> SexEnum sex = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 学生证一对一</span></span><br><span class="line">    <span class="keyword">private</span> IDCard idCard;</span><br><span class="line">    <span class="comment">// 任务，一对多</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Task&gt; stuTasks = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// settter getter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MaleStudent</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MaleForm maleForm = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// setter getter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FemaleStudent</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> FemaleForm femaleForm = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// setter getter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上可见，MyBatis中级联，在POJO中的属性就应体现出级联。</p>
<p>&nbsp;</p>
<h3 id="8-3-配置mapper文件"><a href="#8-3-配置mapper文件" class="headerlink" title="8.3 配置mapper文件"></a>8.3 配置mapper文件</h3><p>级联核心，对每个实体类创建接口后配置mapper文件。</p>
<p>Task</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;xxx.TaskMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getTask&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;xxx.Task&quot;</span>&gt;</span></span><br><span class="line">        select id, title from t_task where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>IDCard</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;xxx.IDCardMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getCardByStuId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;xxx.IDCard&quot;</span>&gt;</span></span><br><span class="line">        select id, stuId, name from t_card where stuId = #&#123;stuId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>ST 任务安排表</strong>：association元素代表一对一级联的开始。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;xxx.STMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">&quot;ST&quot;</span> <span class="attr">id</span>=<span class="string">&quot;STMap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;stu_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;stuId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;task&quot;</span> <span class="attr">column</span>=<span class="string">&quot;task_id&quot;</span> <span class="attr">select</span>=<span class="string">&quot;xxx.TaskMapper.getTask&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getSTByStuId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;STMap&quot;</span>&gt;</span></span><br><span class="line">        select id, stuId, name from t_card where stuId = #&#123;stuId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>男女体检表：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;xxx.MaleFormMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getMaleForm&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;xxx.MaleForm&quot;</span>&gt;</span></span><br><span class="line">        select id, stuId, name from t_card where stuId = #&#123;stuId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>学生映射：</strong>本例核心，与其他实体类关联，resultMap元素也可继承</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;xxx.StudentMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">&quot;xxx.Student&quot;</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">reslut</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;idCard&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">select</span>=<span class="string">&quot;xxx.IDCardMapper.getCardByStuId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;studentTasks&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">select</span>=<span class="string">&quot;xxx.STMapper.getSTByStuId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">discriminator</span> <span class="attr">javaType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sex&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;maleFormMapper&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;famaleFormMapper&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">&quot;FemaleStudent&quot;</span> <span class="attr">id</span>=<span class="string">&quot;femaleFormMapper&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;student&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;femaleForm&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">select</span>=<span class="string">&quot;xxx.FemalFormMapper.getFemaleForm&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">&quot;MaleStudent&quot;</span> <span class="attr">id</span>=<span class="string">&quot;maleFormMapper&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;student&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;maleForm&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">select</span>=<span class="string">&quot;xxx.MalFormMapper.getMaleForm&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getSTByStuId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;STMap&quot;</span>&gt;</span></span><br><span class="line">        select id, stuId, name from t_card where stuId = #&#123;stuId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>discriminator：column属性代表用此列进行鉴别，resultMap属性表示采用哪个resultMap映射</p>
<p>&nbsp;</p>
<h3 id="8-4-N-1问题"><a href="#8-4-N-1问题" class="headerlink" title="8.4 N+1问题"></a>8.4 N+1问题</h3><p>以上级联方式，在使用时会引发所有级联共同执行，如只需要部分数据，多余的SQL会浪费资源。如已有N个关联关系完成了级联，只要再加入一个关联关系，就变成了N+1个关联，所有级联SQL都会被执行，但并非所有数据都需要。</p>
<p>为解决此问题，MyBatis提出延迟加载功能，一开始取学生信息时，不将学生证表、体检表、任务表取出，只取学生表和任务安排表信息。当通过学生POJO访问学生证、体检表、任务表时才通过相应SQL取出。</p>
<p>&nbsp;</p>
<h3 id="8-5-延迟加载"><a href="#8-5-延迟加载" class="headerlink" title="8.5 延迟加载"></a>8.5 延迟加载</h3><p>希望一次性把常用的级联数据取出，而不常用的级联数据等到用时才取出。对于这些不常用的级联表采用延迟加载。</p>
<p>在settings配置中有以下两子元素配置级联：</p>
<ul>
<li>lazyLoadingEnabled：全局开关，默认false，开启后所有关联对象都延迟加载；特定关联关系中可设置fetchType覆盖该全局开关</li>
<li>aggressiveLazyLoading：启用时，对任意延迟属性的调用会使带有延迟加载属性的对象完整加载；反之，每种属性按需加载；默认值从3.4.2后变为false；</li>
</ul>
<p>前者决定是否开启延迟加载，后者控制是否采用层级加载，都是全局级别配置。</p>
<p>另有fetchType属性，可以针对某个信息设置，本属性在association和collection中可以设置，有两个值：</p>
<ul>
<li>eager：获得当前POJO后立即加载对应数据</li>
<li>lazy：获得当前POJO后延迟加载对应数据</li>
</ul>
<p>当开启延迟加载，关闭层级加载后，使用此属性即可自定义设置。</p>
<p>&nbsp;</p>
<h3 id="8-6-另一种级联"><a href="#8-6-另一种级联" class="headerlink" title="8.6 另一种级联"></a>8.6 另一种级联</h3><p>基于SQL表连接的基础上，再次设计。虽能消除N+1问题，但较为复杂，浪费内存，不甚推荐，暂不展开。</p>
<p>&nbsp;</p>
<h3 id="8-7-多对多级联"><a href="#8-7-多对多级联" class="headerlink" title="8.7 多对多级联"></a>8.7 多对多级联</h3><p>程序中将此拆分成两个一对多级联来处理。</p>
<p>本例中，用户可以是多个角色，一个角色可以有多个用户。</p>
<p>POJO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// 关联用户一对多</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; users;</span><br><span class="line">    <span class="comment">// setter getter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// 关联角色一对多</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles;</span><br><span class="line">    <span class="comment">// setter getter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Mapper：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;xxx.RoleMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">&quot;Role&quot;</span> <span class="attr">id</span>=<span class="string">&quot;RoleMapper&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;role_name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;users&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">fetchType</span>=<span class="string">&quot;lazy&quot;</span> <span class="attr">select</span>=<span class="string">&quot;xxx.UserMapper.findUserByRoleId&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findRoleByUserId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;RoleMapper&quot;</span>&gt;</span></span><br><span class="line">        select r.id, r.name from t_role r, t_userrole ur where r.id = ur.role_id and r.id=#&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;xxx.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span> <span class="attr">id</span>=<span class="string">&quot;UserMapper&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;user_name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;roles&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">fetchType</span>=<span class="string">&quot;lazy&quot;</span> <span class="attr">select</span>=<span class="string">&quot;xxx.RoleMapper.findRoleByUserId&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findUserByRoleId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;UserMapper&quot;</span>&gt;</span></span><br><span class="line">        select</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;</p>
<h2 id="9-缓存"><a href="#9-缓存" class="headerlink" title="9. 缓存"></a>9. 缓存</h2><p>MyBatis支持缓存，一般放在内存中，提高性能。数据库位于磁盘，速度慢。一般只将命中率高的数据放在缓存。</p>
<h3 id="9-1-一级二级缓存"><a href="#9-1-一级二级缓存" class="headerlink" title="9.1 一级二级缓存"></a>9.1 一级二级缓存</h3><p>MyBatis分为一级缓存和二级缓存。</p>
<p>一级缓存是在SqlSession上的缓存，二级缓存是在SqlSessionFactory上的缓存。默认时MyBatis开启一级缓存，且一级缓存不需要POJO可序列化。</p>
<p>一级缓存：用一个SqlSession获取mapper，用这个mapper先后get同一数据，实际上是用一个SqlSession获取同一数据；此时只执行一次SQL语句；当一个SqlSession第一次通过SQL和参数获取对象后，会将其缓存，若下次SQL和参数都没有变化，并且缓存未超时或声明不需刷新时，就可以从缓存中读取数据。</p>
<p>二级缓存：一级缓存位于SqlSession层面，不同SqlSession缓存不能共享；如需共享就要开启二级缓存，位于Factory层，更高一层；只需在映射文件中加入<code>&lt;cache/&gt;</code>即可。查询结束后需要SqlSession.commit()提交，才会缓存对象到Factory层面。此时需要可序列化。</p>
<p>&nbsp;</p>
<h3 id="9-2-缓存配置与使用"><a href="#9-2-缓存配置与使用" class="headerlink" title="9.2 缓存配置与使用"></a>9.2 缓存配置与使用</h3><ol>
<li><p>只配置<code>&lt;cache/&gt;</code>后，MyBatis会将select的结果缓存，而增删改之后会刷新缓存。</p>
</li>
<li><p><code>&lt;cache/&gt;</code>配置属性：</p>
</li>
</ol>
<ul>
<li>blocking：默认false，不开启阻塞性缓存，读写时不加入JNI的锁；开启后能保证读写安全性，但降低性能</li>
<li>readOnly：缓存内容是否只读，默认false；若开启，不会因为多线程读写造成不一致</li>
<li>eviction：缓存策略，LRU最近最少使用的，即移除最长时间不用的对象；FIFO先入先出；SOFT软引用，移除基于垃圾回收器状态和软引用规则的对象；WEAK弱引用，移除垃圾收集器状态和弱引用规则的对象；默认LRU</li>
<li>flushInterval：ms，默认null，即不主动刷新，只有增删改后才刷新</li>
<li>type：自定义缓存类，要实现接口Cache</li>
<li>size：缓存对象个数，默认1024</li>
</ul>
<ol>
<li><p>如需自定义缓存类就要实现Cache接口，但一般可使用Redis、MongoDB等常用缓存。如有一个Redis实现类RedisCache，则如下配置：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">type</span>=<span class="string">&quot;xxx.RedisCache&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;host&quot;</span> <span class="attr">value</span>=<span class="string">&quot;localhost&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可对SQL单独配置以自定义是否缓存</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">&quot;false&quot;</span> <span class="attr">useCache</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p> 此为默认配置，flushCache对四种SQL都有效；useCache仅select特有。</p>
<p> 如其他mapper文件需要使用本mapper文件的cache配置，可以引用：</p>
<p> <code>&lt;cache-ref namespace=&quot;xxx.Mapper&quot;/&gt;</code></p>
</li>
</ol>
<p>&nbsp;</p>
<h2 id="10-存储过程"><a href="#10-存储过程" class="headerlink" title="10. 存储过程"></a>10. 存储过程</h2><p>数据库概念，是库预先编译好的，放在库内存中的程序片段，具有高性能，可重用的特点。定义了3种类型参数：输入、输出、输入输出。</p>
<p>暂不展开。</p>
<h3 id="10-1-IN和OUT参数"><a href="#10-1-IN和OUT参数" class="headerlink" title="10.1 IN和OUT参数"></a>10.1 IN和OUT参数</h3><h3 id="10-2-游标"><a href="#10-2-游标" class="headerlink" title="10.2 游标"></a>10.2 游标</h3>
        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E5%90%8E%E7%AB%AF/"># 后端</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/03/23/MyBatis-4-%E5%8A%A8%E6%80%81SQL/">MyBatis-4-动态SQL</a>
            
            
            <a class="next" rel="next" href="/2021/03/23/MyBatis-2-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">MyBatis-2-基础配置文件</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© gaylong9 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
