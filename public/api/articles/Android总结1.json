{"title":"Android总结1","slug":"Android总结1","date":"2020-05-15T12:36:25.000Z","updated":"2020-05-15T12:45:53.923Z","comments":true,"path":"api/articles/Android总结1.json","photos":[],"link":"","excerpt":"Android开发App踩坑记录","covers":["/2020/05/15/Android%E6%80%BB%E7%BB%931/zelda.png"],"content":"<p>Android开发App踩坑记录</p>\n<a id=\"more\"></a>\n<p>[toc]</p>\n<h2 id=\"音频\"><a href=\"#音频\" class=\"headerlink\" title=\"音频\"></a>音频</h2><h3 id=\"录音\"><a href=\"#录音\" class=\"headerlink\" title=\"录音\"></a>录音</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 录音部分，以tag的01标记是否正在录音</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (audio.getTag().toString().equals(<span class=\"string\">\"0\"</span>)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 开始录音</span></span><br><span class=\"line\">    audio.setImageResource(R.mipmap.stop);</span><br><span class=\"line\">    audio.setTag(<span class=\"string\">\"1\"</span>);</span><br><span class=\"line\">    time = (String) DateFormat.format(<span class=\"string\">\"yyyyMMdd_HHmmss\"</span>, Calendar.getInstance(Locale.CHINA));</span><br><span class=\"line\"></span><br><span class=\"line\">    String dir_path = Note.<span class=\"keyword\">this</span>.getFilesDir().getPath() + <span class=\"string\">\"/recordings/\"</span>;</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">\"onClick: dir: \"</span> + dir_path);</span><br><span class=\"line\">    File dir = <span class=\"keyword\">new</span> File(dir_path);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!dir.exists())&#123;</span><br><span class=\"line\">        dir.mkdirs();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    String file_name = dir_path + <span class=\"string\">\"/\"</span> + time + <span class=\"string\">\".aac\"</span>;</span><br><span class=\"line\">    recordAudioFile = <span class=\"keyword\">new</span> File(file_name);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!recordAudioFile.createNewFile()) &#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">\"onClick: file create failed.\"</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">\"onClick: file create done.\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// recordAudioFile = File.createTempFile(file_name,\".aac\");</span></span><br><span class=\"line\">    <span class=\"comment\">// recordAudioFile = new File(file_name, \".aac\");</span></span><br><span class=\"line\">    <span class=\"comment\">// 录音设置</span></span><br><span class=\"line\">    mediaRecorder = <span class=\"keyword\">new</span> MediaRecorder();</span><br><span class=\"line\">    mediaRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);</span><br><span class=\"line\">    mediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.DEFAULT);</span><br><span class=\"line\">    mediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC_ELD);</span><br><span class=\"line\">    mediaRecorder.setOutputFile(recordAudioFile.getAbsolutePath());</span><br><span class=\"line\">    <span class=\"comment\">// /data/user/0/com.example.curriculum/cache/</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        mediaRecorder.prepare();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">\"onClick: prepare failed.\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mediaRecorder.start();</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 停止录音</span></span><br><span class=\"line\">    audio.setImageResource(R.mipmap.audio);</span><br><span class=\"line\">    audio.setTag(<span class=\"string\">\"0\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mediaRecorder != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">\"onClick: record stop: \"</span> + recordAudioFile.getPath());</span><br><span class=\"line\">        mediaRecorder.stop();</span><br><span class=\"line\">        mediaRecorder.release();</span><br><span class=\"line\">        mediaRecorder = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getCurrentFocus() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 当前项下插入一个singlerecord</span></span><br><span class=\"line\">            SingleNoteLayout child = (SingleNoteLayout) getCurrentFocus().getParent().getParent();</span><br><span class=\"line\">            create_record(linearLayout.indexOfChild(child), recordAudioFile.getAbsolutePath());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 若无焦点，添加至末尾</span></span><br><span class=\"line\">            create_record(linearLayout.getChildCount()-<span class=\"number\">1</span>, recordAudioFile.getAbsolutePath());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"播音：资源文件\"><a href=\"#播音：资源文件\" class=\"headerlink\" title=\"播音：资源文件\"></a>播音：资源文件</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 播放器需设置为类成员，以保证不会回收，否则播放可能会中断</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> MediaPlayer mediaPlayer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// MediaPlayer.create方法会自动进行设置+prepare</span></span><br><span class=\"line\">mediaPlayer = MediaPlayer.create(<span class=\"keyword\">this</span>, resid);</span><br><span class=\"line\">mediaPlayer.start();</span><br></pre></td></tr></table></figure>\n<h3 id=\"播音：本地文件\"><a href=\"#播音：本地文件\" class=\"headerlink\" title=\"播音：本地文件\"></a>播音：本地文件</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> MediaPlayer mediaPlayer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// new MediaPlayer()的方法不会自动设置及prepare</span></span><br><span class=\"line\">mediaPlayer = <span class=\"keyword\">new</span> MediaPlayer();</span><br><span class=\"line\">mediaPlayer.setDataSource(path);</span><br><span class=\"line\">mediaPlayer.prepare();\t</span><br><span class=\"line\">mediaPlayer.setOnCompletionListener(<span class=\"keyword\">new</span> MediaPlayer.OnCompletionListener() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCompletion</span><span class=\"params\">(MediaPlayer mp)</span> </span>&#123;</span><br><span class=\"line\">        mp.stop();</span><br><span class=\"line\">        mp.release();</span><br><span class=\"line\">        mp = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">\"play: complete\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">mediaPlayer.start();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">    e.printStackTrace();</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">\"play: file_path is wrong.\"</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 最后勿加stop release等</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h2 id=\"LinearLayout的动态增删控件\"><a href=\"#LinearLayout的动态增删控件\" class=\"headerlink\" title=\"LinearLayout的动态增删控件\"></a>LinearLayout的动态增删控件</h2><p>增：addView时需要index参数，getChildCount、getChildAt、indexOfChild是很常用的方法。</p>\n<p>删：removeView、removeViewAt、removeViewAll</p>\n<p><br></p>\n<h2 id=\"控件嵌套的parent\"><a href=\"#控件嵌套的parent\" class=\"headerlink\" title=\"控件嵌套的parent\"></a>控件嵌套的parent</h2><p>控件嵌套，同时只能点击到某个子控件，要通过子控件获取父级控件甚至更高级控件，可以使用onClick的参数view，一路getParent获取，同时使用getClass判断类型。多层嵌套时可能要使用多次getParent。</p>\n<p><br></p>\n<h2 id=\"权限框架\"><a href=\"#权限框架\" class=\"headerlink\" title=\"权限框架\"></a>权限框架</h2><p>easypermissions</p>\n<p>www.jianshu.com/p/41b093d213fb</p>\n<p><br></p>\n<h2 id=\"ImageView-上下空白区域\"><a href=\"#ImageView-上下空白区域\" class=\"headerlink\" title=\"ImageView 上下空白区域\"></a>ImageView 上下空白区域</h2><p>图片像素大于屏幕像素时，显示有问题。尝试以下设置：android:adjustViewBounds=”true” 。</p>\n<p>Glide注入图片，与androidx/android10可能兼容性较差，出现了奇怪错误。</p>\n<p><br></p>\n<h2 id=\"createNewFile\"><a href=\"#createNewFile\" class=\"headerlink\" title=\"createNewFile()\"></a>createNewFile()</h2><p>要在手动建立的文件夹下，才可create</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 建立文件夹</span></span><br><span class=\"line\">String dir_path = Note.<span class=\"keyword\">this</span>.getFilesDir().getPath() + <span class=\"string\">\"/new_dir/\"</span>;</span><br><span class=\"line\">Log.d(TAG, <span class=\"string\">\"onClick: dir: \"</span> + dir_path);</span><br><span class=\"line\">File dir = <span class=\"keyword\">new</span> File(dir_path);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!dir.exists())&#123;</span><br><span class=\"line\">    dir.mkdirs();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 在该文件夹下建文件</span></span><br><span class=\"line\">String filename = dir_path + <span class=\"string\">\"/hi.txt\"</span>;</span><br><span class=\"line\">File des = <span class=\"keyword\">new</span> File(filename);</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!des.createNewFile()) &#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">\"onClick: file already exists\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">\"onClick: test file create done.\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">    e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h2 id=\"数据库升级\"><a href=\"#数据库升级\" class=\"headerlink\" title=\"数据库升级\"></a>数据库升级</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dbHelper = <span class=\"keyword\">new</span> MyDBHelper(<span class=\"keyword\">this</span>, <span class=\"string\">\"Course.db\"</span>, <span class=\"keyword\">null</span>, <span class=\"number\">2</span>);</span><br><span class=\"line\">db = dbHelper.getWritableDatabase();</span><br></pre></td></tr></table></figure>\n<p>首行参数指定新的version_code，DBHelper.class的onUpgrade中，针对不同版本的升级做出判断与操作。</p>\n<p><br></p>\n<h2 id=\"Uri-fromFile-new-File-path\"><a href=\"#Uri-fromFile-new-File-path\" class=\"headerlink\" title=\"Uri.fromFile(new File(path))\"></a>Uri.fromFile(new File(path))</h2><p>报错：java.io.FileNotFoundException: open failed: EACCES (Permission denied)</p>\n<p>解决：<code>android:requestLegacyExternalStorage=&quot;true&quot;</code> application</p>\n<p><br></p>\n<h2 id=\"imageView-setImageURI-uri\"><a href=\"#imageView-setImageURI-uri\" class=\"headerlink\" title=\"imageView.setImageURI(uri)\"></a>imageView.setImageURI(uri)</h2><p>从库中读取string，setImageURI(Uri.pairse(string))会报错：</p>\n<p>java.lang.SecurityException: Permission Denial: opening provider … that is not exported from UID 10096</p>\n<p>无合适解决方法，改用setImageURI(Uri.fromFile(new File(path)))。</p>\n<p>但是该方法获得的Uri，调用图库查看图片时又会引起FileUriExposedException异常 :sweat:</p>\n<p><br></p>\n<h2 id=\"intent向前传递的顺序问题\"><a href=\"#intent向前传递的顺序问题\" class=\"headerlink\" title=\"intent向前传递的顺序问题\"></a>intent向前传递的顺序问题</h2><p>子活动返回result，即setResult()是在被finish()之前。</p>\n<p>子活动setResult()之后，主活动的onActivityResult()就会启动。这就会导致<strong>onActivityResult()先于子活动的onDestroy()</strong>。</p>\n<p>同时，onPause()， onStop()， onDestroy()中调用setResult()也是不安全的，这些步骤可能会在finish()之后。</p>\n<p><br></p>\n<h2 id=\"录音设置\"><a href=\"#录音设置\" class=\"headerlink\" title=\"录音设置\"></a>录音设置</h2><p>编码器、输出文件、文件后缀之间的协调：最终采用文件指定后缀、输出文件Default、编码器与文件后缀匹配</p>\n<p><img src=\"/2020/05/15/Android%E6%80%BB%E7%BB%931/zelda.png\" alt></p>\n","categories":[],"tags":[{"name":"Android","slug":"Android","count":1,"path":"api/tags/Android.json"}]}