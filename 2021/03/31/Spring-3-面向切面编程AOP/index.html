<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="gaylong9">



    <meta name="description" content="年更博客 自娱自乐">



<title>Spring-3-面向切面编程AOP | gaylong9`s blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">gaylong9&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">gaylong9&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Spring-3-面向切面编程AOP</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">gaylong9</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 31, 2021&nbsp;&nbsp;10:02:20</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p> </p>
<a id="more"></a>
<!-- toc -->
<ul>
<li><a href="#1-spring-aop%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">1. Spring AOP基本概念</a>
<ul>
<li><a href="#11-aop%E6%A6%82%E5%BF%B5%E5%92%8C%E6%84%8F%E4%B9%89">1.1 AOP概念和意义</a></li>
<li><a href="#12-aop%E6%9C%AF%E8%AF%AD">1.2 AOP术语</a></li>
<li><a href="#13-spring%E5%AF%B9aop%E7%9A%84%E6%94%AF%E6%8C%81">1.3 Spring对AOP的支持</a></li>
</ul>
</li>
<li><a href="#2-aspectj%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0aop">2. @AspectJ注解实现AOP</a>
<ul>
<li><a href="#21-%E9%80%89%E6%8B%A9%E5%88%87%E7%82%B9">2.1 选择切点</a></li>
<li><a href="#22-%E5%88%9B%E5%BB%BA%E5%88%87%E9%9D%A2">2.2 创建切面</a></li>
<li><a href="#23-%E8%BF%9E%E6%8E%A5%E7%82%B9">2.3 连接点</a></li>
<li><a href="#24-%E6%B5%8B%E8%AF%95">2.4 测试</a></li>
<li><a href="#25-%E7%8E%AF%E7%BB%95%E9%80%9A%E7%9F%A5">2.5 环绕通知</a></li>
<li><a href="#26-%E7%BB%87%E5%85%A5">2.6 织入</a></li>
<li><a href="#27-%E7%BB%99%E9%80%9A%E7%9F%A5%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0">2.7 给通知传递参数</a></li>
<li><a href="#28-%E5%BC%95%E5%85%A5">2.8 引入</a></li>
</ul>
</li>
<li><a href="#3-xml%E9%85%8D%E7%BD%AEspring-aop">3. XML配置Spring AOP</a>
<ul>
<li><a href="#31-%E5%AE%9A%E4%B9%89%E9%80%9A%E7%9F%A5">3.1 定义通知</a></li>
<li><a href="#32-%E7%BB%99%E9%80%9A%E7%9F%A5%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0">3.2 给通知传递参数</a></li>
<li><a href="#33-%E5%BC%95%E5%85%A5">3.3 引入</a></li>
</ul>
</li>
<li><a href="#4-%E6%97%A9%E6%9C%9Fspring-aop%E5%AE%9E%E7%8E%B0">4. 早期Spring AOP实现</a></li>
<li><a href="#5-%E5%A4%9A%E4%B8%AA%E5%88%87%E9%9D%A2">5. 多个切面</a></li>
</ul>
<!-- tocstop -->
<p> </p>
<p>[toc]</p>
<p>IoC是Spring的核心，那么AOP就是Spring最为重要的功能之一。在数据库事务中，切面编程被广泛使用。</p>
<h1><span id="1-spring-aop基本概念"> 1. Spring AOP基本概念</span></h1>
<p>在动态代理基础上，在代理类（实现bind，invoke方法的类）中，加入拦截器作为属性，bind方法中获取拦截器保存在属性中，invoke方法中执行拦截器的方法。</p>
<h2><span id="11-aop概念和意义"> 1.1 AOP概念和意义</span></h2>
<p>尤其在数据库事务中，OOP不能完全解决问题。如交易系统和财务系统，购物过程中这两个系统应形成统一的事务管理。事务管理就需要用到面向切面的编程，切面环境就是数据库事务。</p>
<p>AOP的一些意义：拦截一些方法、把对象组织成一个整体、约定动态流程完成各阶段的自定义操作等。</p>
<p>减少代码冗余：JDBC或MyBatis中，都需要try-catch-finally，手动获取连接/映射器，进行各种异常判断。而在AOP中，只需加入一个注解，代码就可抛开try-catch-finally，专注于业务逻辑，更简洁，更易维护。</p>
<p>实现原理：正常的SQL步骤是完成连接、执行SQL，若成功则提交、失败则回滚。这个过程可以放在拦截器中，与被代理对象一并执行。即，可以将SQL流程封装，通过动态代理技术，设计为：建立连接放在拦截器的before方法、执行SQL则是被代理对象的方法、回滚与提交则通过是否发生异常来判断决定，同样放在拦截器中、关闭连接等数据库资源同样拦截器中实现。</p>
<p>AOP的封装：上述的拦截器内置在AOP中，建立连接、判断回滚与提交、关闭连接等都由AOP自行完成，用户只需编写SQL完成业务逻辑、标注<code>@Transactional</code>表示启用数据库事务即可。当然也提供一些配置能力。</p>
<p> </p>
<h2><span id="12-aop术语"> 1.2 AOP术语</span></h2>
<ol>
<li>切面 Aspect：在一个怎么样的环境中工作。如上述的简单数据库事务操作，事务贯穿整个代码层面，故事务就是一个切面，能在被代理对象的方法前后、异常或正常返回后切入自定义代码，甚至代替原本被代理对象的方法。动态代理中可以理解为拦截器。</li>
<li>通知 Adice：切面开启后，切面的方法。类似拦截器的方法。
<ol>
<li>前置通知 before：在动态代理反射被代理对象方法前，或执行环绕通知前执行的通知功能</li>
<li>后置通知 after：在动态代理反射被代理对象方法后，或执行环绕通知后执行的通知功能，且无论是否抛出异常，都会执行</li>
<li>返回通知 afterReturning：在动态代理反射被代理对象方法后，或执行环绕通知后执行的通知功能</li>
<li>异常通知 afterThrowing：在动态代理反射被代理对象方法，或执行环绕通知产生异常后执行</li>
<li>环绕通知 aroundThrowing：在动态代理中，可以取代当前被拦截对象的方法，通过参数或反射调用被拦截对象的方法</li>
</ol>
</li>
<li>引入 Introduction：在现有的类里添加自定义的类和方法</li>
<li>切点 Pointcut：被切面拦截的方法（被代理对象的方法）就是一个切点，切面可以将切点和被拦截方法按照一定逻辑织入约定流程中</li>
<li>连接点 join point：判断条件，由它指定哪些是切点；对于指定的切点，Spring生成代理对象去使用对饮的切面进行拦截</li>
<li>织入 Weaving：生成代理对象的过程。代理分为静态和动态。静态代理是在编译class文件时生成的代码逻辑，或通过ClassLoader在类加载时生成的代码逻辑，在应用程序代码运行前就生成了对应的逻辑；Spring使用动态代理，在运行期动态生成代码，使用JDK或CGLIB动态代理技术</li>
</ol>
<p><img src="/2021/03/31/Spring-3-%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8BAOP/AOP%E6%B5%81%E7%A8%8B.png" alt="AOP流程"></p>
<p> </p>
<h2><span id="13-spring对aop的支持"> 1.3 Spring对AOP的支持</span></h2>
<p>AOP并非Spring独有，Spring只是支持AOP而已。Spring只支持方法拦截的AOP。</p>
<p>Spring有4中方式实现AOP：</p>
<ol>
<li>ProxyFactoryBean和对应接口</li>
<li>XML配置</li>
<li>@AspectJ</li>
<li>AspectJ注入</li>
</ol>
<p>常用@AspectJ注解实现，有时附以XML配置。其余方式很少用。</p>
<p> </p>
<h1><span id="2-aspectj注解实现aop"> 2. @AspectJ注解实现AOP</span></h1>
<h2><span id="21-选择切点"> 2.1 选择切点</span></h2>
<p>Spring是方法级别的AOP框架，以某个方法作为切点。即动态代理中拦截哪个方法。</p>
<p>首先创建一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"id:"</span> + role.getId() + <span class="string">", name: "</span> + role.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果将这个接口类的printRole方法作为切点，则动态代理时就是要为RoleServiceImpl生成代理对象，拦截printRole方法，产生各种通知。</p>
<p> </p>
<h2><span id="22-创建切面"> 2.2 创建切面</span></h2>
<p>选好切点后就可以创建切面。对于动态代理，切面如同拦截器。Spring中只要注解@Aspect，IoC容器就认为该类是一个切面。</p>
<p>@Aspect注解需要aspectj/aspectjweaver的jar包。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleAspect</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterReturning..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另有<code>@Around</code>环绕通知，和<code>@Pointcut()</code>未用到。</p>
<p>@Pointcut：可简化注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"..."</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">Before(<span class="string">"func()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p> </p>
<h2><span id="23-连接点"> 2.3 连接点</span></h2>
<p>判断是否需要拦截某一方法。</p>
<p>切面中的注解 <code>execution(* AOP.RoleServiceImpl(..))</code></p>
<p>execution：执行该方法时候触发拦截器</p>
<p>*：任意返回类型的方法</p>
<p>AOP.RoleServiceImpl：类的全限定名</p>
<p>printRole：被拦截方法名</p>
<p>(…)：任意参数</p>
<p>如此，就确定了要拦截的方法，会按AOP通知的规则将其织入流程。</p>
<p>还有其他诸多指示器：</p>
<table>
<thead>
<tr>
<th>AspectJ指示器</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>arg()</td>
<td>限制方法的参数类型</td>
</tr>
<tr>
<td>@args()</td>
<td>限制方法参数为指定注解标注</td>
</tr>
<tr>
<td>execution</td>
<td>用正则匹配</td>
</tr>
<tr>
<td>this()</td>
<td>匹配AOP代理的Bean，引用为指定类型的类</td>
</tr>
<tr>
<td>target</td>
<td>被代理对象为指定类型</td>
</tr>
<tr>
<td>@target()</td>
<td>被代理对象符合指定的注解类型</td>
</tr>
<tr>
<td>within()</td>
<td>匹配指定包</td>
</tr>
<tr>
<td>@within()</td>
<td>匹配指定类型</td>
</tr>
<tr>
<td>@annotation</td>
<td>匹配带有指定注解的连接点</td>
</tr>
</tbody>
</table>
<p>指示器可以组合使用，如<code>execution(* xxx.*.*.func(..)) &amp;&amp; within(xxx.aop.*)</code>表示只将xxx.aop下的类的func方法作为切点。</p>
<p>XML配置时，&amp;&amp; || ! 用and or not替代。</p>
<p> </p>
<h2><span id="24-测试"> 2.4 测试</span></h2>
<p>配置Bean，开启AspectJ的自动代理，Spring生成动态代理对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"AOP"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOPConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RoleAspect <span class="title">getRoleAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RoleAspect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或使用XML配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='UTF-8' ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd        </span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop-4.0.xsd"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"roleAspect"</span> <span class="attr">class</span>=<span class="string">"com.ssm.chapter11.aop.aspect.RoleAspect"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"roleService"</span> <span class="attr">class</span>=<span class="string">"com.ssm.chapter11.aop.service.impl.RoleServiceImpl"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(AOPConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//        RoleService roleService = (RoleService) context.getBean(RoleService.class);</span></span><br><span class="line">        RoleService roleService = (RoleService) context.getBean(<span class="string">"roleServiceImpl"</span>);</span><br><span class="line">        System.out.println(roleService.getClass());</span><br><span class="line">        Role role = <span class="keyword">new</span> Role(<span class="number">1</span>, <span class="string">"jsy"</span>);</span><br><span class="line">        roleService.printRole(role);</span><br><span class="line">        System.out.println(<span class="string">"___________"</span>);</span><br><span class="line">        role = <span class="keyword">null</span>;</span><br><span class="line">        roleService.printRole(role);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class com.sun.proxy.$Proxy22</span><br><span class="line">before...</span><br><span class="line">id:1, name: jsy</span><br><span class="line">afterReturning...</span><br><span class="line">after...</span><br><span class="line">___________</span><br><span class="line">before...</span><br><span class="line">afterThrowing...</span><br><span class="line">after...</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.NullPointerException</span><br></pre></td></tr></table></figure>
<p> </p>
<h2><span id="25-环绕通知"> 2.5 环绕通知</span></h2>
<p>同时实现前置和后置通知，保留了调度被代理对象原有方法的功能。可控性不强，仅用于大量改变业务逻辑时。</p>
<p>在切面中加入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around</span>(<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint jp)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"around before..."</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jp.proceed();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        throwable.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"around after..."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ProceedingJoinPoint，Spring提供，用于反射切点方法。</p>
<p>此时测试：具体顺序或与Spring版本或配置方式有关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class com.sun.proxy.$Proxy23</span><br><span class="line">around before...</span><br><span class="line">before...</span><br><span class="line">id:1, name: jsy</span><br><span class="line">afterReturning...</span><br><span class="line">after...</span><br><span class="line">around after...</span><br></pre></td></tr></table></figure>
<p> </p>
<h2><span id="26-织入"> 2.6 织入</span></h2>
<p>是生成代理对象的过程（内含被代理对象、拦截器的代理对象，运行结果就像是将通知方法织入被代理对象）。上述代码中，切点方法所在类都是拥有接口的类；若没有接口也可使用CGLIB完成动态代理。故Spring规定：类存在接口使用JDK动态代理，织入各个通知；没有接口就是用CGLIB完成动态代理。</p>
<p>动态代理对象是由IoC容器生成的，一般不需修改。Spring建议使用接口+实现类的编程方式，使定义和实现分离，有利于实现变化和替换。</p>
<p> </p>
<h2><span id="27-给通知传递参数"> 2.7 给通知传递参数</span></h2>
<p>如切点是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"id:"</span> + role.getId() + <span class="string">", name: "</span> + role.getName() + <span class="string">"age: "</span> + age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..)) &amp;&amp; args(role, age)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Role role, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"before..."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即在连接点中加入args属性，并在通知中加入同名参数。</p>
<p> </p>
<h2><span id="28-引入"> 2.8 引入</span></h2>
<p>有时希望引入一些其他类的方法，加入通知流程中。</p>
<p>原理是给代理对象增加可挂载接口，即可通过强转在不同类之间转换，执行不同方法。</p>
<p>本例中，加入一个verify方法判断Role不为null时才输出信息：</p>
<p>先创建RoleVerify接口和实例化对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleVerify</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span> <span class="params">(Role role)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleVerifyImpl</span> <span class="keyword">implements</span> <span class="title">RoleVerify</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(Role role)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> role != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并在Aspect中加入Verify属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeclareParents</span>(value = <span class="string">"AOP.RoleServiceImpl+"</span>, defaultImpl = RoleVerifyImpl<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">RoleVerify</span> <span class="title">roleVerify</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>@DeclareParents</code>注解：</p>
<ol>
<li>value：XXX+，表示对某个类增强，为其引入一个新接口</li>
<li>defaultImpl：XXX.class，新接口的默认实现类</li>
</ol>
<p>测试使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(AOPConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//        RoleService roleService = (RoleService) context.getBean(RoleService.class);</span></span><br><span class="line"><span class="comment">//        RoleService roleService = (RoleService) context.getBean("roleServiceImpl");</span></span><br><span class="line">RoleService roleService = context.getBean(RoleService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RoleVerify roleVerify = (RoleVerify) roleService; </span><br><span class="line"><span class="comment">//        System.out.println(roleService.getClass());</span></span><br><span class="line">Role role = <span class="keyword">new</span> Role(<span class="number">1</span>, <span class="string">"jsy"</span>);</span><br><span class="line"><span class="keyword">if</span> (roleVerify.verify(role)) &#123;</span><br><span class="line">    roleService.printRole(role, <span class="number">23</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将roleService强转为RoleVerify类型，进而使用verify方法，且是通过RoleVerifyImpl实现的。</p>
<p>原理：</p>
<p>生成代理对象的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">    obj.getClass().getClassLoader(), </span><br><span class="line">    obj.getClass().getInterfaces(), </span><br><span class="line">    <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p><code>obj.getClass().getInterfaces()</code> 表示代理对象挂在多个接口下，只要AOP让代理对象挂在两接口下，就可以强转Bean，增强了Bean的功能。</p>
<p>若没有接口，使用CGLIB，使用Enhancer雷猴的interfaces属性，代表挂载代理对象接口。</p>
<p> </p>
<h1><span id="3-xml配置spring-aop"> 3. XML配置Spring AOP</span></h1>
<table>
<thead>
<tr>
<th>AOP配置元素</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>aop:config</td>
<td>顶层元素</td>
</tr>
<tr>
<td>aop:advisor</td>
<td>定义AOP的通知器，古老方式</td>
</tr>
<tr>
<td>aop:aspect</td>
<td>定义切面</td>
</tr>
<tr>
<td>aop:before</td>
<td>定义前置通知</td>
</tr>
<tr>
<td>aop:after</td>
<td>定义后置通知</td>
</tr>
<tr>
<td>aop:around</td>
<td>定义环绕方式</td>
</tr>
<tr>
<td>aop:after-returning</td>
<td>定义返回通知</td>
</tr>
<tr>
<td>aop:after-throwing</td>
<td>定义异常通知</td>
</tr>
<tr>
<td>aop:declare-parents</td>
<td>给通知引入新接口，增强功能</td>
</tr>
<tr>
<td>aop:pointcut</td>
<td>定义切点</td>
</tr>
</tbody>
</table>
<p>本例中仍使用上例的RoleService接口和RoleServiceImpl类，但不需@Component注解。</p>
<p>随后定义切面类：同样无需注解，稍后统一XML配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlAspect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterReturning..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用XML配置AOP时需要在顶层beans中引入XML定义AOP的命名空间</p>
<p><code>http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</code></p>
<h2><span id="31-定义通知"> 3.1 定义通知</span></h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"xmlAspect"</span> <span class="attr">class</span>=<span class="string">"AOP.XmlAspect"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"roleService"</span> <span class="attr">class</span>=<span class="string">"AOP.RoleServiceImpl1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引用xmlAspect作为切面 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"xmlAspect"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切面内定义通知 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"before"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"after"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"afterThrowing"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">"afterReturning"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">"around"</span> <span class="attr">pointcut-ref</span>=<span class="string">"printRole"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>或定义切点减少冗余：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义切点方法减少冗余 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"printRole"</span> <span class="attr">expression</span>=<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..))"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"before"</span> <span class="attr">pointcut-ref</span>=<span class="string">"printRole"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试时使用<code>Application ctx = new ClassPathXmlApplicationContext(&quot;xxx.xml&quot;)</code>获取IoC容器。</p>
<p> </p>
<h2><span id="32-给通知传递参数"> 3.2 给通知传递参数</span></h2>
<p>通知方法加入形参，随后在XML中的连接点中加入<code>args()</code>属性，<strong>此处用and连接</strong>，因为&amp;在XML中有特殊含义。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"printRole"</span> <span class="attr">expression</span>=<span class="string">"execution(* AOP.RoleServiceImpl.printRole(..)) and args(role, age)"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p> </p>
<h2><span id="33-引入"> 3.3 引入</span></h2>
<p>在RoleServiceImpl（被代理类 ？，注解引用时是加入切面类中）中加入RoleVerify属性 <code>public RoleVerify roleVerify = null;</code></p>
<p>随后XML配置：aop:aspect下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:declare-parents</span></span></span><br><span class="line"><span class="tag">         <span class="attr">types-matching</span>=<span class="string">"xxx.RoleServiceImpl+"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">implement-interface</span>=<span class="string">"xxx.RoleVerify"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">default-impl</span>=<span class="string">"xxx.RoleVerifierImpl"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p> </p>
<h1><span id="4-早期spring-aop实现"> 4. 早期Spring AOP实现</span></h1>
<p>暂不展开，《JavaEE互联网轻量级框架整合开发 SSM框架和Redis实现》11.5</p>
<p> </p>
<h1><span id="5-多个切面"> 5. 多个切面</span></h1>
<p>多个切面时，默认随机执行，可通过以下操作指定顺序。</p>
<p>新建接口与实现类（切点）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultiBean</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMulti</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiBeanImpl</span> <span class="keyword">implements</span> <span class="title">MultiBean</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMulti</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"test multi aspects."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建多个切面：此处仅写出一个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aspect1</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(* AOP.MultiBeanImpl.testMulti(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before 1..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"after 1..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(<span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing 1..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(<span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterReturning 1..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Config类设置与Test类测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"AOP"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Aspect1 <span class="title">getAspect1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Aspect1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Aspect2 <span class="title">getAspect2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Aspect2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(MultiConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">MultiBean multiBean = (MultiBean) context.getBean(<span class="string">"multiBeanImpl"</span>);</span><br><span class="line">multiBean.testMulti();</span><br></pre></td></tr></table></figure>
<p><s>但是结果一直是同一个顺序啊 迷幻</s></p>
<p>如要指定顺序，在注解AOP中，可以使用<code>@Order</code>：在Aspect1中加入<code>@Order(1)</code>，在Aspect2中加入<code>@Order(2)</code>…</p>
<p>还有其他方法：如Aspect实现Ordered接口，实现getOrder方法，返回自己的次序；XML中则<code>&lt;aop:aspect ref=&quot;aspect1&quot; order=&quot;1&quot;&gt;</code></p>
<p>指定顺序后，则按照以下顺序执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">before 1...</span><br><span class="line">before 2...</span><br><span class="line">test multi aspects.</span><br><span class="line">afterReturning 2...</span><br><span class="line">after 2...</span><br><span class="line">afterReturning 1...</span><br><span class="line">after 1...</span><br></pre></td></tr></table></figure>
<p>类似设计模式中的责任链模式。即Spring底层通过责任链模式处理多个切面。</p>
<p> </p>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E5%90%8E%E7%AB%AF/"># 后端</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/04/01/Spring-4-Spring%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B/">Spring-4-Spring和数据库编程</a>
            
            
            <a class="next" rel="next" href="/2021/03/24/Spring-2-%E8%A3%85%E9%85%8DSpring-Bean/">Spring-2-装配Spring_Bean</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© gaylong9 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
